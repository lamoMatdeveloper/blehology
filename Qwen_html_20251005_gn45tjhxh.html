<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLEHOLOGY — Local Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .message-user { background-color: rgba(11, 192, 164, 0.2); }
    .message-assistant { background-color: rgba(255, 255, 255, 0.1); }
    .scrollable { display: flex; flex-direction: column; height: 75vh; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem; }
    .composer { padding: 0.75rem; background: rgba(14, 24, 41, 0.6); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); }
    /* Markdown styles */
    .markdown-content p { margin: 0.5rem 0; }
    .markdown-content ul, .markdown-content ol { padding-left: 1.5rem; margin: 0.5rem 0; }
    .markdown-content li { margin: 0.25rem 0; }
    .markdown-content code { background: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
    .markdown-content pre { background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; }
    .markdown-content pre code { background: none; padding: 0; }
    .markdown-content blockquote { border-left: 3px solid #09C3D6; padding-left: 1rem; margin: 0.5rem 0; color: #ccc; font-style: italic; }
    .markdown-content strong { font-weight: 600; color: #a7f3d0; }
    .markdown-content em { font-style: italic; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
      margin: 1rem 0 0.5rem;
      color: #e6d4b8;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f3d3a] via-[#2f574d] to-[#e6d4b8] text-slate-100 min-h-screen">

  <!-- Top Bar -->
  <header class="w-full h-16 px-6 flex items-center justify-between border-b border-white/10 backdrop-blur-xl bg-white/5">
    <h1 class="text-lg font-semibold tracking-wide">BLEHOLOGY</h1>
    <div class="flex items-center gap-3">
      <div class="relative">
        <svg class="w-4 h-4 absolute left-2 top-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-width="1.5" d="m21 21-4.35-4.35M10 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12Z"/>
        </svg>
        <input placeholder="Search..." class="pl-8 pr-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-100 placeholder:text-slate-400 outline-none w-40"/>
      </div>
      <div class="flex items-center gap-2 text-xs text-slate-300">
        <span>BLEH Assistant</span>
        <div id="status-indicator" class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
      </div>
    </div>
  </header>

  <!-- Chat Container -->
  <main class="flex-1 grid place-items-center px-6 py-6">
    <div class="w-full max-w-4xl rounded-2xl bg-white/10 border border-white/10 backdrop-blur-xl flex flex-col overflow-hidden scrollable">
      <div id="messages" class="messages space-y-4"></div>
      <div class="composer flex gap-2">
        <textarea
          id="user-input"
          placeholder="Escribe algo para bleh..."
          class="flex-1 resize-none rounded-xl bg-white/5 border border-white/10 text-slate-100 px-3 py-2 text-sm outline-none placeholder:text-slate-500"
          rows="1"
        ></textarea>
        <button
          id="send-btn"
          class="flex items-center gap-2 px-4 rounded-xl bg-gradient-to-r from-[#09C3D6] to-[#2D7BFF] text-white text-sm font-medium hover:opacity-90"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="1.5" d="m4 12 16-8-7 8 7 8-16-8Z"/>
          </svg>
          Enviar
        </button>
      </div>
    </div>
  </main>

  <script>
    // 🔑 DeepSeek API (local prototype only!)
    const DEEPSEEK_API_KEY = "sk-58fe2e04c98e498280195ef6cd98c784";
    const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions"; // ✅ No trailing spaces!

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const statusIndicator = document.getElementById("status-indicator");

    let messages = [];
    let isLoading = false;

    const idGen = () => Math.random().toString(36).slice(2);

    // ✅ Simple but effective Markdown renderer
    function renderMarkdown(text) {
      if (!text) return "";
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^(#{1,3})\s+(.*)$/gm, (match, hashes, content) => {
          const level = hashes.length;
          return `<h${level}>${content}</h${level}>`;
        })
        .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>')
        .replace(/^-\s+(.*)$/gm, '<ul><li>$1</li></ul>')
        .replace(/^\d+\.\s+(.*)$/gm, '<ol><li>$1</li></ol>')
        .replace(/\n/g, '<br>');
    }

    function addMessage(role, text, id = idGen()) {
      const div = document.createElement("div");
      div.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;
      div.innerHTML = `
        <div class="px-4 py-2 rounded-2xl text-sm ${role === "user" ? "message-user" : "message-assistant"}">
          <div class="markdown-content">${renderMarkdown(text)}</div>
        </div>
      `;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      messages.push({ id, role, text });
      return id;
    }

    // BLEH System Prompt (shortened but functional)
    const SYSTEM_PROMPT = `[SYSTEM — BLEH/blehology v1.2 — EN]
You are BLEH, NASA biosciences assistant. Mission: make space biology knowledge accurate, understandable, and useful.

Rules:
1. Always respond in English.
2. Use Markdown: **bold**, *italic*, \`code\`, lists, blockquotes.
3. Keep answers low-noise, high-signal.
4. Never invent data. If unsure, say so.`;

    async function sendMessage() {
      const val = inputEl.value.trim();
      if (!val || isLoading) return;

      inputEl.value = "";
      isLoading = true;
      sendBtn.disabled = true;
      statusIndicator.classList.add("bg-emerald-400");
      statusIndicator.classList.remove("bg-slate-600");

      addMessage("user", val);

      const apiMessages = [
        { role: "system", content: SYSTEM_PROMPT },
        ...messages.map(m => ({ role: m.role, content: m.text })),
        { role: "user", content: val }
      ];

      try {
        const response = await fetch(DEEPSEEK_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
          },
          body: JSON.stringify({
            model: "deepseek-chat",
            messages: apiMessages,
            stream: true,
            temperature: 0.7,
          }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        if (!response.body) throw new Error("No stream support");

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";
        const msgId = addMessage("assistant", "");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split("\n").filter(line => line.trim() !== "");

          for (const line of lines) {
            // ✅ Correct SSE parsing for DeepSeek
            if (line.startsWith(" ")) {
              const data = line.substring(6).trim();
              if (data === "[DONE]") continue;

              try {
                const json = JSON.parse(data);
                const token = json.choices[0]?.delta?.content || "";
                if (token) {
                  fullText += token;
                  const lastMsg = messagesEl.lastChild;
                  if (lastMsg) {
                    lastMsg.querySelector(".markdown-content").innerHTML = renderMarkdown(fullText);
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                  }
                }
              } catch (e) {
                console.warn("Parse error", line);
              }
            }
          }
        }

        messages[messages.length - 1].text = fullText;

      } catch (err) {
        console.error("Error:", err);
        addMessage("assistant", `⚠️ Error: ${err.message}`);
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        statusIndicator.classList.remove("bg-emerald-400");
        statusIndicator.classList.add("bg-slate-600");
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Welcome message
    setTimeout(() => {
      addMessage("assistant", "Hello! I'm **BLEH**, your NASA biosciences assistant. Ask me anything about space biology, human health in orbit, or GeneLab data!");
    }, 300);
  </script>
</body>
</html>