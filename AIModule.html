<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLEHOLOGY ‚Äî NASA RAG Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }
    body { font-family: system-ui, sans-serif; }
    .message-user { background-color: rgba(11, 192, 164, 0.2); }
    .message-assistant { background-color: rgba(29, 104, 80, 0.1); }
    .scrollable { display: flex; flex-direction: column; height: 75vh; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem; }
    .composer { padding: 0.75rem; background: rgba(5, 67, 52, 0.6); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); }
    .markdown-content p { margin: 0.5rem 0; }
    .markdown-content ul, .markdown-content ol { padding-left: 1.5rem; margin: 0.5rem 0; }
    .markdown-content li { margin: 0.25rem 0; }
    .markdown-content code { background: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
    .markdown-content pre { background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; }
    .markdown-content pre code { background: none; padding: 0; }
    .markdown-content blockquote { border-left: 3px solid #09C3D6; padding-left: 1rem; margin: 0.5rem 0; color: #ccc; font-style: italic; }
    .markdown-content strong { font-weight: 600; color: #a7f3d0; }
    .markdown-content em { font-style: italic; }
    .settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
    .settings-content { background: #0E1829; margin: 2rem auto; padding: 1.5rem; width: 90%; max-width: 500px; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1); }
    .btn-level, .btn-format, .btn-unit { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; cursor: pointer; }
    .btn-level.active, .btn-format.active, .btn-unit.active { background: rgba(11, 192, 164, 0.3); }
    .btn-mode { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; }
    .btn-mode.active { background: rgba(11, 192, 164, 0.3); }
    .settings-content select {
      background-color: #2D3748; /* Dark Grey */
    }
    .settings-content option {
      background-color: #2D3748; /* Dark Grey */
      color: white;
    }
    /* Note: Hover on <option> is not consistently supported across all browsers */
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f3d3a] via-[#2f574d] to-[#e6d4b8] text-slate-100 min-h-screen" style="background: transparent;">

  <header class="w-full h-16 px-6 flex items-center justify-between border-b border-white/10 backdrop-blur-xl bg-white/5">
    <div class="flex items-center gap-6">
      <h1 class="text-lg font-semibold tracking-wide">BLEHOLOGY</h1>
      <nav class="flex gap-5 text-sm text-slate-300"></nav>
    </div>
    <button id="settings-btn" class="text-sm text-slate-300 hover:text-white">‚öôÔ∏è Settings</button>
  </header>
  <h1 style="color: rgba(255, 255, 255, 0.603);text-align: center;">Image generated with AI</h1>
  <img src="BlehAlien.gif" alt="This is Bleh, a very helpful alien." style="opacity: 0.8; align-self: center; justify-self: center;">
 
  <main class="flex-1 grid place-items-center px-6 py-6" style="position: absolute; bottom: 0px;">
    <div class="w-full max-w-4xl rounded-2xl bg-white/10 border border-white/10 backdrop-blur-xl flex flex-col overflow-hidden scrollable" style="height: 50vh;">
      <div id="messages" class="messages space-y-4"></div>
      <div class="composer flex gap-2 items-center">
        <div class="flex items-center gap-1 pr-2">
          <span class="text-[11px] text-slate-300">Mode:</span>
          <button id="chatmode-search" class="btn-mode active" title="Search NASA ROOT + summarize">Search</button>
          <button id="chatmode-chat" class="btn-mode" title="Chat without searching">Chat</button>
        </div>
        <textarea id="user-input" placeholder="Type something for BLEH..." class="flex-1 resize-none rounded-xl bg-white/5 border border-white/10 text-slate-100 px-3 py-2 text-sm outline-none placeholder:text-slate-500" rows="1"></textarea>
        <button id="send-btn" class="flex items-center gap-2 px-4 rounded-xl bg-gradient-to-r from-[#0599a6] to-[#07aa6d] text-white text-sm font-medium hover:opacity-90">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" d="m4 12 16-8-7 8 7 8-16-8Z"/></svg>
          Send
        </button>
      </div>
    </div>
  </main>

  <div id="settings-modal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Settings</h2>
        <button id="close-settings" class="text-slate-400 hover:text-white">‚úï</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Reading Level</label>
          <div class="flex gap-2">
            <button class="btn-level active" data-level="basic">basic</button>
            <button class="btn-level" data-level="intermediate">intermediate</button>
            <button class="btn-level" data-level="expert">expert</button>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">Answer Length</label>
          <select id="answer-length" class="w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-sm">
            <option value="short">short</option>
            <option value="medium" selected>medium</option>
            <option value="long">long</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Format</label>
          <div class="flex gap-2">
            <button class="btn-format" data-format="bullets">bullets</button>
            <button class="btn-format active" data-format="paragraph">paragraph</button>
            <button class="btn-format" data-format="mixed">mixed</button>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">Units</label>
          <div class="flex gap-2">
            <button class="btn-unit active" data-unit="SI">SI</button>
            <button class="btn-unit" data-unit="imperial">imperial</button>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">Mode</label>
          <select id="mode-select" class="w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-sm">
            <option value="auto">auto</option>
            <option value="research">research</option>
            <option value="conversational">conversational</option>
          </select>
        </div>
      </div>
      <div>
        <br>
        <label class="flex items-center text-sm mb-1">
          <input type="checkbox" id="tts-enabled" checked> <span>  Enable voice</span>
        </label>
      </div>

      <div class="flex gap-2 mt-6">
        <button id="save-settings" class="px-4 py-1 bg-emerald-500 text-white rounded text-sm">Save</button>
        <button id="reset-settings" class="px-4 py-1 bg-gray-600 text-white rounded text-sm">Reset</button>
      </div>
    </div>
  </div>

  <!-- Firebase + NASA ROOT search (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCIU-q88QGBqNmydsvnB_HaoONK1SNEAzE",
      authDomain: "blehology.firebaseapp.com",
      databaseURL: "https://blehology-default-rtdb.firebaseio.com/",
      projectId: "blehology",
      storageBucket: "blehology.firebasestorage.app",
      messagingSenderId: "166464430045",
      appId: "1:166464430045:web:77566d918ba41c43c86034",
      measurementId: "G-T2T1QWYQ2"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function isUrlLike(v){ return typeof v === 'string' && /^https?:\/\//i.test(v); }

    function flattenNASAData(obj, pathParts = ['NASA ROOT']){
      const out = [];
      function walk(node, parts){
        if (node == null) return;
        if (typeof node === 'string'){
          if (isUrlLike(node)) out.push({ title: parts[parts.length-1], url: node, path: '/' + parts.join('/') });
          return;
        }
        if (Array.isArray(node)) { node.forEach((child, i)=>walk(child, parts.concat(String(i)))); return; }
        if (typeof node === 'object'){
          const hasUrl = isUrlLike(node.url) || isUrlLike(node.link);
          if (hasUrl){
            out.push({ title: node.title || parts[parts.length-1], url: node.url || node.link, description: node.description || node.summary || '', path: '/' + parts.join('/') });
          }
          Object.keys(node).forEach(k=>{ if(!['url','link','title','description','summary'].includes(k)) walk(node[k], parts.concat(k)); });
        }
      }
      walk(obj, pathParts);
      return out;
    }

    function scoreItem(query, item){
      const q = (query||'').toLowerCase();
      const t = (item.title||'').toLowerCase();
      const p = (item.path||'').toLowerCase();
      const d = (item.description||'').toLowerCase();
      const u = (item.url||'').toLowerCase();
      let s = 0;
      if (t.includes(q)) s += 50; if (p.includes(q)) s += 10; if (d.includes(q)) s += 10; if (u.includes(q)) s += 4;
      const toks = q.split(/\s+/).filter(Boolean);
      toks.forEach(tok=>{ if(t.includes(tok)) s+=6; if(p.includes(tok)) s+=3; if(d.includes(tok)) s+=2; });
      return s;
    }

    async function fetchNASAIndex(){
      const snap = await get(ref(database, 'NASA ROOT'));
      return snap.exists() ? snap.val() : {};
    }

    async function searchNASA(query){
      try {
        let items = [];
        if (window.BLEH_NASA && Array.isArray(window.BLEH_NASA.cache) && window.BLEH_NASA.cache.length){
          items = window.BLEH_NASA.cache;
        } else {
          const data = await fetchNASAIndex();
          items = flattenNASAData(data);
        }
        const ranked = items.map(it=>({ ...it, _score: scoreItem(query, it) })).sort((a,b)=>b._score-a._score);
        const best = ranked[0] && ranked[0]._score>0 ? ranked[0] : null;
        return { best, candidates: ranked.slice(0,5) };
      } catch(e){ console.warn('NASA search error', e); return { best:null, candidates:[] }; }
    }

    onValue(ref(database, 'NASA ROOT'), (snapshot)=>{
      try{
        const data = snapshot.val() || {};
        window.BLEH_NASA = window.BLEH_NASA || {};
        window.BLEH_NASA.cache = flattenNASAData(data);
        window.BLEH_NASA.lastUpdated = Date.now();
        console.log('NASA ROOT cache items:', window.BLEH_NASA.cache?.length || 0);
      }catch{}
    }, { onlyOnce: false });

    window.BLEH_NASA = window.BLEH_NASA || {};
    window.BLEH_NASA.searchNASA = searchNASA;
  </script>

  <!-- Main Chat + RAG integration (non-module) -->
  <script>
    const DEEPSEEK_API_KEY = "sk-58fe2e04c98e498280195ef6cd98c784"; // Local prototype only
    const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const settingsBtn = document.getElementById("settings-btn");
    const closeSettings = document.getElementById("close-settings");
    const settingsModal = document.getElementById("settings-modal");

    let messages = [];
    let isLoading = false;

    let userPrefs = { reading_level: "basic", answer_length: "medium", format: "paragraph", units: "SI", mode: "auto", tts_enabled: true };
    let chatPipelineMode = 'search'; // 'search' (RAG) or 'chat' (no search)

    function loadPrefs(){ const saved = localStorage.getItem("bleh_prefs"); if(saved){ try{ userPrefs = { ...userPrefs, ...JSON.parse(saved) }; }catch{} } applyPrefs(); }
    function savePrefs(){ localStorage.setItem("bleh_prefs", JSON.stringify(userPrefs)); applyPrefs(); }
    function applyPrefs(){
      document.getElementById("answer-length").value = userPrefs.answer_length;
      document.getElementById("mode-select").value = userPrefs.mode;
      document.getElementById("tts-enabled").checked = userPrefs.tts_enabled;
      document.querySelectorAll(".btn-level").forEach(btn=>btn.classList.toggle("active", btn.dataset.level===userPrefs.reading_level));
      document.querySelectorAll(".btn-format").forEach(btn=>btn.classList.toggle("active", btn.dataset.format===userPrefs.format));
      document.querySelectorAll(".btn-unit").forEach(btn=>btn.classList.toggle("active", btn.dataset.unit===userPrefs.units));
    }

    const idGen = ()=> Math.random().toString(36).slice(2);
    function renderMarkdown(text){
      if(!text) return "";
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>')
        .replace(/^\-\s+(.*)$/gm, '<ul><li>$1</li></ul>')
        .replace(/^\d+\.\s+(.*)$/gm, '<ol><li>$1</li></ol>')
        .replace(/\n/g, '<br>');
    }
    function addMessage(role, text, id=idGen()){
      const div = document.createElement("div");
      div.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;
      div.innerHTML = `<div class="px-4 py-2 rounded-2xl text-sm ${role === "user" ? "message-user" : "message-assistant"}"><div class="markdown-content">${renderMarkdown(text)}</div></div>`;
      messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight; messages.push({ id, role, text }); return id;
    }

    function getSystemPrompt(){
      return `[SYSTEM ‚Äî BLEH/blehology v1.3 ‚Äî EN]
You are BLEH, NASA biosciences assistant. Mission: make space biology knowledge accurate, understandable, and useful.

User profile:
- Reading level: ${userPrefs.reading_level}
- Answer length: ${userPrefs.answer_length}
- Format: ${userPrefs.format}
- Units: ${userPrefs.units}
- Mode: ${userPrefs.mode}

Rules:
1. Always respond in English.
2. In "research" mode: cite sources, be evidence-based.
3. In "conversational" mode: be brief (2‚Äì6 lines), no citations unless asked.
4. Never invent data. If unsure, say so.
5. Use Markdown: **bold**, *italic*, \`code\`, lists.
6. Keep answers low-noise, high-signal.
7. When provided with ARTICLE_CONTENT and a SOURCE_URL, first produce a concise, useful summary, then a monospaced ASCII mind map in a single fenced code block, keeping connectors aligned.
`;
    }

    function estimateTokens(str){ return Math.ceil((str||'').length/4); }
    function trimMessages(msgs, systemPrompt, newUserMessage, maxTokens=3500){
      const systemTokens = estimateTokens(systemPrompt); const userTokens = estimateTokens(newUserMessage); const buffer = 500;
      let total = systemTokens + userTokens; let trimmed = [];
      for(let i = msgs.length-1; i>=0; i--){ const msgTokens = estimateTokens(msgs[i].text); if(total + msgTokens > maxTokens - buffer) break; total += msgTokens; trimmed.unshift(msgs[i]); }
      return trimmed;
    }

    function speakText(text){
      if(!userPrefs.tts_enabled) return; speechSynthesis.cancel();
      const cleanText = (text||'')
        .replace(/[\*_~`]/g,'')
        .replace(/```[\s\S]*?```/g,'')
        .replace(/`[^`]*`/g,'')
        .replace(/\[([^\]]+)\]\([^)]+\)/g,'$1')
        .replace(/>\s*/g,'')
        .replace(/\n+/g,' ')
        .replace(/\s+/g,' ').trim();
      if(!cleanText) return; const utter = new SpeechSynthesisUtterance(cleanText); utter.rate=0.9; utter.pitch=1.1; utter.lang='en-US'; speechSynthesis.speak(utter);
    }

    async function sendMessage(){
      const val = inputEl.value.trim(); if(!val || isLoading) return;
      inputEl.value = ""; isLoading = true; sendBtn.disabled = true; addMessage("user", val);

      const systemPrompt = getSystemPrompt();
      let apiMessages; let usedRAG=false; let selectedSource=null;

      async function fetchArticleViaProxy(url){
        try{
          const clean = url.trim();
          const prefix = clean.startsWith('http') ? clean : `https://${clean}`;
          const proxied = `https://r.jina.ai/${prefix}`;
          const resp = await fetch(proxied, { method:'GET' });
          if(!resp.ok) throw new Error(`Article fetch HTTP ${resp.status}`);
          const text = await resp.text();
          return text.slice(0, 12000);
        }catch(e){ console.warn('Article fetch failed', e); return ''; }
      }

      if (chatPipelineMode === 'search') {
        try{
          const search = await (window.BLEH_NASA?.searchNASA ? window.BLEH_NASA.searchNASA(val) : Promise.resolve({best:null}));
          if(search && search.best && search.best.url){
            selectedSource = search.best;
            const articleText = await fetchArticleViaProxy(selectedSource.url);
            if(articleText && articleText.length>200){
              usedRAG = true;
              const ragInstruction = [
                `USER_QUERY: ${val}`,
                `SOURCE_PATH: ${selectedSource.path || ''}`,
                `SOURCE_TITLE: ${selectedSource.title || ''}`,
                `SOURCE_URL: ${selectedSource.url}`,
                '',
                'ARTICLE_CONTENT (truncated):',
                '```',
                articleText,
                '```',
                '',
                'TASK:',
                '- First, provide a useful, evidence-based summary tailored to the user profile (reading level, length, format).',
                '- Then, output a monospaced ASCII mind map in a single fenced code block. Follow this layout exactly (update labels to fit the article; keep connectors):',
                '```',
                'ü™ê {ARTICLE TITLE}',
                '                                   ‚îÇ',
                '        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê',
                '        ‚îÇ                                                     ‚îÇ',
                '     üéØ OVERVIEW                                          üéØ KEY FINDINGS',
                '  "{one-sentence gist}"                           1. Finding 1',
                '                                                   2. Finding 2',
                '                                   ‚îÇ',
                '                         üî¨ METHODS / CONTEXT',
                '                                   ‚îÇ',
                '           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê',
                '           ‚îÇ                                            ‚îÇ',
                '   üß™ KEY CONCEPTS                               üéì IMPLICATIONS / APPLICATIONS',
                ' - Concept A                                      - Application A',
                ' - Concept B                                      - Application B',
                '```',
                '',
                'After the mind map, include a single line: Source: {SOURCE_URL}',
              ].join('\n');

              apiMessages = [ { role:'system', content: systemPrompt }, { role:'user', content: ragInstruction } ];
            }
          }
        }catch(e){ console.warn('RAG pipeline error', e); }
      }

      if(!apiMessages){
        const trimmedHistory = trimMessages(messages, systemPrompt, val);
        apiMessages = [ { role: 'system', content: systemPrompt }, ...trimmedHistory.map(m=>({ role:m.role, content:m.text })), { role:'user', content: val } ];
      }

      try {
        const response = await fetch(DEEPSEEK_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DEEPSEEK_API_KEY}` },
          body: JSON.stringify({ model: "deepseek-chat", messages: apiMessages, stream: true, temperature: 0.7 })
        });
        if(!response.ok) throw new Error(`HTTP ${response.status}`);
        if(!response.body) throw new Error("No stream support");

        const reader = response.body.getReader(); const decoder = new TextDecoder(); let fullText = "";
        const prefixMsg = usedRAG && selectedSource ? `Found a relevant article in NASA ROOT. Summarizing and mapping: ${selectedSource.title}\n\n` : "";
        addMessage("assistant", prefixMsg);

        while(true){ const {done, value} = await reader.read(); if(done) break; const chunk = decoder.decode(value, {stream:true}); const lines = chunk.split("\n").filter(l=>l.trim()!=="");
          for(const line of lines){ if(line.startsWith("data: ")){ const data = line.substring(6).trim(); if(data === "[DONE]") continue; try{ const json = JSON.parse(data); const token = json.choices[0]?.delta?.content || ""; if(token){ fullText += token; const lastMsg = messagesEl.lastChild; if(lastMsg){ lastMsg.querySelector(".markdown-content").innerHTML = renderMarkdown(prefixMsg + fullText); messagesEl.scrollTop = messagesEl.scrollHeight; } } }catch(e){ console.warn('Parse error', line); } } }
        }

        messages[messages.length - 1].text = (messages[messages.length - 1].text || "") + fullText;
        speakText(fullText);
      } catch(err){ console.error("Error:", err); addMessage("assistant", `‚ö†Ô∏è Error: ${err.message}`); }
      finally { isLoading = false; sendBtn.disabled = false; }
    }

    // Settings modal handlers
    settingsBtn.addEventListener("click", ()=> settingsModal.style.display = "block");
    closeSettings.addEventListener("click", ()=> settingsModal.style.display = "none");
    window.addEventListener("click", (e)=>{ if(e.target === settingsModal) settingsModal.style.display = "none"; });

    document.getElementById("save-settings").addEventListener("click", ()=>{
      userPrefs.reading_level = document.querySelector(".btn-level.active").dataset.level;
      userPrefs.answer_length = document.getElementById("answer-length").value;
      userPrefs.format = document.querySelector(".btn-format.active").dataset.format;
      userPrefs.units = document.querySelector(".btn-unit.active").dataset.unit;
      userPrefs.mode = document.getElementById("mode-select").value;
      userPrefs.tts_enabled = document.getElementById("tts-enabled").checked;
      savePrefs(); settingsModal.style.display = "none"; alert("Settings saved!");
    });

    document.getElementById("reset-settings").addEventListener("click", ()=>{
      userPrefs = { reading_level: "basic", answer_length: "medium", format: "paragraph", units: "SI", mode: "auto", tts_enabled: true };
      savePrefs(); alert("Settings reset.");
    });

    document.querySelectorAll(".btn-level").forEach(btn=> btn.addEventListener("click", ()=>{ document.querySelectorAll(".btn-level").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }));
    document.querySelectorAll(".btn-format").forEach(btn=> btn.addEventListener("click", ()=>{ document.querySelectorAll(".btn-format").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }));
    document.querySelectorAll(".btn-unit").forEach(btn=> btn.addEventListener("click", ()=>{ document.querySelectorAll(".btn-unit").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }));

    // Mode toggle (Search vs Chat)
    const modeSearchBtn = document.getElementById('chatmode-search');
    const modeChatBtn = document.getElementById('chatmode-chat');
    if (modeSearchBtn && modeChatBtn){
      modeSearchBtn.addEventListener('click', ()=>{ chatPipelineMode='search'; modeSearchBtn.classList.add('active'); modeChatBtn.classList.remove('active'); });
      modeChatBtn.addEventListener('click', ()=>{ chatPipelineMode='chat'; modeChatBtn.classList.add('active'); modeSearchBtn.classList.remove('active'); });
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    setTimeout(()=>{ addMessage("assistant", "Hello! I'm **BLEH**, your NASA biosciences assistant. Ask me about space biology, human health in orbit, or ask me to research an article from NASA ROOT."); }, 300);
    loadPrefs();
  </script>

</body>
</html>
